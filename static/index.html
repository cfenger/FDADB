<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FDA Document Q&A</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #0b1324;
      --accent: #44d1b6;
      --accent-2: #83a5ff;
      --text: #e5e7eb;
      --muted: #8aa0c2;
      --border: #1f2a44;
      --danger: #f87171;
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Space Grotesk", "Inter", "Segoe UI", sans-serif;
      background: radial-gradient(120% 120% at 20% 20%, rgba(68, 209, 182, 0.08), transparent),
        radial-gradient(90% 90% at 80% 10%, rgba(131, 165, 255, 0.1), transparent),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 20px 60px;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      letter-spacing: 0.4px;
    }
    .brand-badge {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      display: grid;
      place-items: center;
      color: #0b1324;
      font-weight: 800;
      box-shadow: var(--shadow);
    }
    nav {
      display: flex;
      gap: 12px;
    }
    nav button {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.18s ease;
      font-weight: 600;
    }
    nav button.active {
      background: linear-gradient(135deg, rgba(68, 209, 182, 0.18), rgba(131, 165, 255, 0.18));
      border-color: rgba(68, 209, 182, 0.6);
      color: #eafff6;
      box-shadow: var(--shadow);
    }
    nav button:hover {
      border-color: var(--accent);
    }
    button:disabled { opacity: 0.55; cursor: not-allowed; }
    .ghost {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.18s ease;
      font-weight: 600;
    }
    .ghost:hover { border-color: var(--accent); }
    .ghost.danger { border-color: rgba(248, 113, 113, 0.5); color: #fca5a5; }
    .ghost.danger:hover { border-color: var(--danger); color: #fecdd3; }
    .ghost.secondary { border-color: var(--accent); color: var(--accent); }
    .ghost.secondary:hover { border-color: var(--accent-2); color: var(--accent-2); }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      display: none;
    }
    .panel.active { display: block; }
    h2 {
      margin-top: 0;
      margin-bottom: 12px;
      font-size: 22px;
    }
    .muted { color: var(--muted); }
    .upload-area {
      border: 1px dashed var(--border);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 14px;
      background: rgba(255, 255, 255, 0.02);
    }
    .upload-controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    button.primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #0b1324;
      border: none;
      padding: 12px 16px;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      box-shadow: var(--shadow);
    }
    button.primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    button.primary:not(:disabled):hover { transform: translateY(-1px); }
    .status {
      margin-top: 8px;
      font-size: 14px;
    }
    .status.error { color: var(--danger); }
    .status.warning { color: #fbbf24; }
    .doc-list {
      margin-top: 12px;
      display: grid;
      gap: 10px;
    }
    .doc-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 8px;
    }
    .doc-card {
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.03);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .doc-meta { color: var(--muted); font-size: 13px; }
    textarea, input[type="text"] {
      width: 100%;
      background: #0b1428;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 12px;
      border-radius: 12px;
      font-size: 15px;
      font-family: inherit;
    }
    textarea:focus, input:focus {
      outline: 1px solid var(--accent);
      border-color: var(--accent);
    }
    .ask-layout {
      display: grid;
      gap: 16px;
    }
    .answer {
      padding: 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(68, 209, 182, 0.04);
      min-height: 60px;
    }
    .sources { margin-top: 10px; color: var(--muted); font-size: 14px; }
    .history {
      margin-top: 16px;
      border-top: 1px solid var(--border);
      padding-top: 12px;
      display: grid;
      gap: 10px;
    }
    .history-item {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.02);
    }
    .label {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 12px;
      letter-spacing: 0.3px;
      background: rgba(68, 209, 182, 0.14);
      color: #c2fff1;
      margin-bottom: 6px;
    }
    @media (max-width: 700px) {
      header { flex-direction: column; align-items: flex-start; gap: 12px; }
      nav { width: 100%; }
      nav button { flex: 1; }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="brand">
        <div class="brand-badge">Q&A</div>
        <div>
          <div>FDA Document Q&A</div>
          <div class="muted" style="font-size:13px;">Upload once, ask anything.</div>
        </div>
      </div>
      <nav>
        <button id="nav-upload" class="active">Upload documents</button>
        <button id="nav-ask">Ask questions</button>
      </nav>
    </header>

    <section id="upload-panel" class="panel active">
      <h2>Upload documents</h2>
      <p class="muted">Files are stored in a shared vector store; everyone can query them.</p>
      <div class="upload-area">
        <div class="upload-controls">
          <input id="file-input" type="file" multiple />
          <button id="upload-btn" class="primary">Upload to OpenAI</button>
          <button id="retry-btn" class="ghost secondary" disabled>Retry failed uploads</button>
        </div>
        <div id="upload-status" class="status"></div>
      </div>
      <div>
        <div class="doc-header">
          <div class="muted">Known documents</div>
          <button id="delete-all-btn" class="ghost danger">Delete all</button>
        </div>
        <div id="doc-status" class="status"></div>
        <div id="doc-list" class="doc-list"></div>
      </div>
    </section>

    <section id="ask-panel" class="panel">
      <h2>Ask questions</h2>
      <p class="muted">Powered by the OpenAI Responses API with File Search.</p>
      <div class="ask-layout">
        <textarea id="question" rows="4" placeholder="Ask about policies, procedures, or anything in your docs..."></textarea>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <button id="ask-btn" class="primary">Ask</button>
          <div id="ask-status" class="status"></div>
        </div>
        <div>
          <div class="muted">Latest answer</div>
          <div id="answer" class="answer"></div>
          <div id="sources" class="sources"></div>
        </div>
        <div class="history">
          <div class="muted">This session</div>
          <div id="history-items"></div>
        </div>
      </div>
    </section>
  </div>

  <script>
    const docListEl = document.getElementById("doc-list");
    const uploadStatus = document.getElementById("upload-status");
    const docStatus = document.getElementById("doc-status");
    const askStatus = document.getElementById("ask-status");
    const historyEl = document.getElementById("history-items");
    const answerEl = document.getElementById("answer");
    const sourcesEl = document.getElementById("sources");
    const uploadBtn = document.getElementById("upload-btn");
    const deleteAllBtn = document.getElementById("delete-all-btn");
    const retryBtn = document.getElementById("retry-btn");
    const askBtn = document.getElementById("ask-btn");
    const fileInput = document.getElementById("file-input");
    const questionInput = document.getElementById("question");

    const MAX_CONCURRENT_UPLOADS = 2;
    let retryQueue = [];
    const state = { documents: [], history: [] };

    function switchPanel(target) {
      document.getElementById("upload-panel").classList.remove("active");
      document.getElementById("ask-panel").classList.remove("active");
      document.getElementById(target).classList.add("active");
      document.getElementById("nav-upload").classList.toggle("active", target === "upload-panel");
      document.getElementById("nav-ask").classList.toggle("active", target === "ask-panel");
    }

    document.getElementById("nav-upload").addEventListener("click", () => switchPanel("upload-panel"));
    document.getElementById("nav-ask").addEventListener("click", () => switchPanel("ask-panel"));

    function setDocStatus(message, isError = false) {
      docStatus.textContent = message || "";
      docStatus.classList.toggle("error", !!isError);
    }

    async function fetchDocuments() {
      try {
        const res = await fetch("/api/documents");
        if (!res.ok) throw new Error("Could not load documents");
        const data = await res.json();
        state.documents = data.documents || [];
        setDocStatus("");
        renderDocuments();
      } catch (err) {
        setDocStatus(err.message, true);
      }
    }

    function renderDocuments() {
      docListEl.innerHTML = "";
      deleteAllBtn.disabled = !state.documents.length;
      if (!state.documents.length) {
        docListEl.innerHTML = `<div class="muted">No documents yet. Upload to get started.</div>`;
        return;
      }
      state.documents.forEach((doc) => {
        const card = document.createElement("div");
        card.className = "doc-card";
        const status = doc.processing_status || "ready";
        let statusBadge = `<span class="label">Ready</span>`;
        if (status === "indexing") {
          statusBadge = `<span class="label" style="background: rgba(255, 193, 94, 0.18); color: #ffd7a0;">Indexing</span>`;
        } else if (status === "failed") {
          statusBadge = `<span class="label" style="background: rgba(248, 113, 113, 0.15); color: #fca5a5;">Failed</span>`;
        } else if (status === "skipped_duplicate") {
          statusBadge = `<span class="label" style="background: rgba(131, 165, 255, 0.15); color: #c7d5ff;">Duplicate</span>`;
        } else if (status === "retry_suggested") {
          statusBadge = `<span class="label" style="background: rgba(255, 193, 94, 0.24); color: #ffe3ad;">Retry suggested</span>`;
        }
        const hasSize = typeof doc.size_bytes === "number";
        const main = document.createElement("div");
        main.innerHTML = `
          ${statusBadge}
          <div><strong>${doc.original_filename}</strong></div>
          <div class="doc-meta">Uploaded: ${new Date(doc.uploaded_at).toLocaleString()}</div>
          ${
            doc.error_message
              ? `<div class="doc-meta" style="color:#fca5a5; margin-top:6px;">${doc.error_message}</div>`
              : ""
          }
        `;
        const actions = document.createElement("div");
        actions.style.display = "flex";
        actions.style.flexDirection = "column";
        actions.style.alignItems = "flex-end";
        actions.style.gap = "6px";
        actions.innerHTML = `<div class="doc-meta">${hasSize ? (doc.size_bytes / 1024).toFixed(1) + " KB" : ""}</div>`;
        const viewBtn = document.createElement("button");
        viewBtn.className = "ghost secondary";
        viewBtn.textContent = doc.viewable ? "View" : "View (unavailable)";
        viewBtn.disabled = !doc.viewable;
        viewBtn.addEventListener("click", () => {
          if (!doc.viewable) return;
          const url = `/api/documents/${doc.id}/content`;
          window.open(url, "_blank", "noopener");
        });
        actions.appendChild(viewBtn);
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "ghost danger";
        deleteBtn.textContent = "Delete";
        deleteBtn.addEventListener("click", () => handleDeleteDocument(doc));
        actions.appendChild(deleteBtn);
        card.appendChild(main);
        card.appendChild(actions);
        docListEl.appendChild(card);
      });
    }

    async function uploadSingleFile(file) {
      const form = new FormData();
      form.append("files", file);
      const res = await fetch("/api/upload", { method: "POST", body: form });
      if (!res.ok) {
        const error = await res.json().catch(() => ({}));
        throw new Error(error.detail || "Upload failed");
      }
      return res.json();
    }

    async function runUploadQueue(files) {
      let processed = 0;
      const total = files.length;
      const newDocs = [];
      const failedFiles = [];
      const skippedDuplicates = [];
      const counts = { ready: 0, indexing: 0, failed: 0, skipped_duplicate: 0, retry_suggested: 0 };
      return new Promise((resolve) => {
        let active = 0;
        let index = 0;
        const next = () => {
          if (index >= files.length && active === 0) {
            return resolve({ processed, total, newDocs, failedFiles, skippedDuplicates, counts });
          }
          while (active < MAX_CONCURRENT_UPLOADS && index < files.length) {
            const file = files[index++];
            active += 1;
            uploadStatus.textContent = `Uploading (${processed + 1}/${total}): ${file.name}...`;
            uploadSingleFile(file)
              .then((data) => {
                const docs = data.documents || [];
                newDocs.push(...docs);
                docs.forEach((doc) => {
                  const status = doc.processing_status || "ready";
                  counts[status] = (counts[status] || 0) + 1;
                  if (status === "skipped_duplicate") {
                    skippedDuplicates.push(doc.original_filename);
                  }
                  if (status === "failed" || status === "retry_suggested") {
                    failedFiles.push({
                      file,
                      message: doc.error_message || "Upload failed; please retry.",
                    });
                    retryQueue.push(file);
                  }
                });
              })
              .catch((err) => {
                failedFiles.push({ file, message: err.message });
                counts.failed += 1;
                retryQueue.push(file);
              })
              .finally(() => {
                processed += 1;
                active -= 1;
                next();
              });
          }
        };
        next();
      });
    }

    function summarizeUploadResult(result, failedFiles) {
      const { processed, total, counts, skippedDuplicates, newDocs } = result;
      uploadStatus.classList.remove("error", "warning");
      let message = `Processed ${processed}/${total} file(s).`;
      if (counts.ready) message += ` Ready: ${counts.ready}.`;
      if (counts.indexing)
        message += " Some files are still being indexed; you may need to wait before querying them.";
      if (counts.retry_suggested) message += ` Retry suggested: ${counts.retry_suggested}.`;
      if (skippedDuplicates.length) {
        message += ` Skipped duplicates: ${skippedDuplicates.join(", ")}.`;
      }
      if (failedFiles.length) {
        const names = failedFiles
          .map((f) => `${f.file.name}${f.message ? ` (${f.message})` : ""}`)
          .join("; ");
        message += ` Failed: ${failedFiles.length} (${names}). Other files in the batch were still processed.`;
        uploadStatus.classList.add("error");
      } else if (counts.indexing || counts.retry_suggested) {
        uploadStatus.classList.add("warning");
      }
      uploadStatus.textContent = message;
      const docsToAdd = newDocs.filter((doc) =>
        ["ready", "indexing"].includes(doc.processing_status || "ready")
      );
      if (docsToAdd.length) {
        state.documents = [...state.documents, ...docsToAdd];
        renderDocuments();
      }
      retryBtn.disabled = retryQueue.length === 0;
    }

    async function handleUploads(files) {
      if (!files.length) {
        uploadStatus.textContent = "Select at least one file.";
        uploadStatus.classList.add("error");
        return;
      }
      uploadBtn.disabled = true;
      retryBtn.disabled = true;
      uploadStatus.textContent = "Preparing upload...";
      uploadStatus.classList.remove("error", "warning");
      retryQueue = [];
      try {
        const result = await runUploadQueue(files);
        summarizeUploadResult(result, result.failedFiles || []);
      } catch (err) {
        uploadStatus.textContent = err.message;
        uploadStatus.classList.add("error");
      } finally {
        uploadBtn.disabled = false;
        fileInput.value = "";
      }
    }

    uploadBtn.addEventListener("click", async () => {
      const files = Array.from(fileInput.files);
      await handleUploads(files);
    });

    retryBtn.addEventListener("click", async () => {
      if (!retryQueue.length) {
        uploadStatus.textContent = "No failed uploads to retry.";
        uploadStatus.classList.add("warning");
        return;
      }
      const filesToRetry = [...retryQueue];
      retryQueue = [];
      await handleUploads(filesToRetry);
    });

    async function handleDeleteDocument(doc) {
      setDocStatus(`Deleting "${doc.original_filename}"...`);
      try {
        const res = await fetch(`/api/documents/${doc.id}`, { method: "DELETE" });
        if (!res.ok) {
          const error = await res.json().catch(() => ({}));
          throw new Error(error.detail || "Delete failed");
        }
        state.documents = state.documents.filter((d) => d.id !== doc.id);
        renderDocuments();
        setDocStatus(`Deleted "${doc.original_filename}".`);
      } catch (err) {
        setDocStatus(err.message, true);
      }
    }

    deleteAllBtn.addEventListener("click", async () => {
      if (!state.documents.length) {
        setDocStatus("No documents to delete.", true);
        return;
      }
      const confirmed = confirm(
        "Delete all documents and remove their OpenAI files? This cannot be undone."
      );
      if (!confirmed) return;
      deleteAllBtn.disabled = true;
      setDocStatus("Deleting all documents...");
      try {
        const res = await fetch("/api/documents", { method: "DELETE" });
        if (!res.ok) {
          const error = await res.json().catch(() => ({}));
          throw new Error(error.detail || "Delete all failed");
        }
        const data = await res.json();
        state.documents = [];
        renderDocuments();
        const count = data.deleted ?? 0;
        setDocStatus(`Deleted ${count} document${count === 1 ? "" : "s"}.`);
      } catch (err) {
        setDocStatus(err.message, true);
      } finally {
        deleteAllBtn.disabled = false;
      }
    });

    askBtn.addEventListener("click", async () => {
      const question = questionInput.value.trim();
      if (!question) {
        askStatus.textContent = "Enter a question.";
        askStatus.classList.add("error");
        return;
      }
      askBtn.disabled = true;
      askStatus.textContent = "Thinking...";
      askStatus.classList.remove("error");
      try {
        const res = await fetch("/api/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question }),
        });
        if (!res.ok) {
          const error = await res.json().catch(() => ({}));
          throw new Error(error.detail || "Request failed");
        }
        const data = await res.json();
        renderAnswer(data);
        state.history.unshift({
          question,
          answer: data.answer,
          sources: data.sources || [],
          citations: data.citations || [],
        });
        renderHistory();
        askStatus.textContent = "";
      } catch (err) {
        askStatus.textContent = err.message;
        askStatus.classList.add("error");
      } finally {
        askBtn.disabled = false;
      }
    });

    function renderAnswer(data) {
      answerEl.textContent = data.answer || "";
      renderSources(data, sourcesEl);
    }

    function renderHistory() {
      historyEl.innerHTML = "";
      if (!state.history.length) {
        historyEl.innerHTML = `<div class="muted">Ask a question to start building history.</div>`;
        return;
      }
      state.history.forEach((entry) => {
        const item = document.createElement("div");
        item.className = "history-item";
        const q = document.createElement("div");
        q.innerHTML = `<div class="label">Q</div><div>${entry.question}</div>`;
        const a = document.createElement("div");
        a.innerHTML = `<div class="label" style="margin-top:10px;">A</div><div>${entry.answer}</div>`;
        const sourcesWrapper = document.createElement("div");
        sourcesWrapper.className = "sources";
        sourcesWrapper.style.marginTop = "8px";
        renderSources(entry, sourcesWrapper, true);
        item.appendChild(q);
        item.appendChild(a);
        item.appendChild(sourcesWrapper);
        historyEl.appendChild(item);
      });
    }

    function renderSources(data, targetEl, isHistory = false) {
      if (!targetEl) return;
      targetEl.innerHTML = "";
      const citations = data.citations || [];
      if (citations.length) {
        const list = document.createElement("ul");
        list.style.paddingLeft = "18px";
        list.style.margin = "6px 0";
        citations.forEach((c) => {
          const li = document.createElement("li");
          const idx = c.citation_index ?? "?";
          const snippet = c.snippet || "Snippet unavailable.";
          li.textContent = `[${idx}] ${c.original_filename} â€” ${snippet}`;
          list.appendChild(li);
        });
        const heading = document.createElement("div");
        heading.textContent = "Sources:";
        targetEl.appendChild(heading);
        targetEl.appendChild(list);
        return;
      }
      if (data.sources && data.sources.length) {
        const names = data.sources.map((s) => s.original_filename).join(", ");
        targetEl.textContent = `Sources: ${names}`;
      } else {
        targetEl.textContent = isHistory ? "Sources: n/a" : "Sources: not provided.";
      }
    }

    fetchDocuments();
  </script>
</body>
</html>
